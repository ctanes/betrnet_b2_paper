---
title: |
  ![](logo_blk.png){width=5in}  
  BetrNet
author: "Ceylan Tanes"
date: \today
header-includes:
   - \usepackage{float}
   - \usepackage{pdflscape}
   - \newcommand{\blandscape}{\begin{landscape}}
   - \newcommand{\elandscape}{\end{landscape}}
output: 
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r knitr setup, echo=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(
  tidy=FALSE,
  cache=FALSE,
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  dpi=100,
  fig.width=5,
  fig.height=3,
  fig.align = "center"
  )
```


```{r child = 'betrnet_16S_preamble.Rmd'}
```

```{r}
s_ba <- s %>%
  filter(!isControl) %>%
  filter(!FINAL_WITHDRAW %in% "No (patient completely withdrawn from study)") %>%
  select(subject_id, study_group_collapse, on_ppi, ANTIBIO, FINAL_HX, AGE, SEX, BMI_RANGE, ASPIRIN, SMOKEEVER, STATINS, HEARTBURN) %>%
  unique() %>%
  filter(!is.na(subject_id)) 


extra_subject <- clinical_data %>% 
  filter(subject_id == "B2M073") %>% 
  select(one_of(c(colnames(s_ba)))) %>%
  mutate(study_group_collapse = "Healthy") %>%
  mutate(on_ppi = TRUE)

s_ba <- bind_rows(s_ba, extra_subject) %>%  
  mutate(on_ppi = ifelse(on_ppi, "PPI", "no PPI")) %>%
  mutate(on_ppi = factor(on_ppi)) %>%
  
  mutate(ASPIRIN = fct_relevel(ASPIRIN, "No", after=0)) %>%
  
  mutate(study_group_collapse = fct_rev(study_group_collapse)) %>%
  mutate(FINAL_HX = factor(FINAL_HX, levels=c("Control", "Intestinal metaplasia, no dysplasia", "Indefinite for dysplasia", "Low grade dysplasia", "High grade dysplasia", "Adenocarcinoma"))) %>%
  
  mutate(pathology_linear = factor(FINAL_HX, ordered=T)) %>%
  
  mutate(pathology2 = fct_collapse(FINAL_HX, `No dysplasia`=c("Intestinal metaplasia, no dysplasia"), Intermediate=c("Indefinite for dysplasia", "Low grade dysplasia"), Advanced=c("High grade dysplasia", "Adenocarcinoma"))) %>%
  mutate(pathology2_linear = factor(pathology2, ordered=T))
  



## read in bile acid data
ba <- read_delim(file.path(data_dir, "BETrNET_August2021_bileacids.csv")) %>%
  pivot_longer(-Subject_ID, names_to = "BA", values_to="value_original") %>%
  mutate(value = ifelse(is.na(value_original), 1, value_original)) %>%
  rename(subject_id = Subject_ID) %>%
  filter(subject_id %in% s_ba$subject_id) %>%
  #left_join(s_ba, by="subject_id") %>%
  mutate(hierarchy = ifelse(BA %in% c("Total_nM", "Primary_Conjugated_nM", "Primary_Unconjugated_nM", "Secondary_Unconjugated_nM", "Secondary_Conjugated_nM"),
                            "grouped", "individual")) %>%
  mutate(value_log = log10(value)) %>%
  
  group_by(BA) %>%
  mutate(perc_present = mean(value > 1)) %>%
  ungroup()
  
s_ba <- s_ba %>%
  filter(subject_id %in% ba$subject_id) %>%
  droplevels()
```


# Are bile acids associated with age, sex, BMI, PPI

```{r}
s_toTest <- s_ba
```


```{r}
ba_toTest <- ba %>%
  left_join(select(s_toTest, subject_id, study_group_collapse, AGE, BMI_RANGE, on_ppi, SEX, SMOKEEVER, STATINS, ASPIRIN, HEARTBURN), by="subject_id") %>%
  
  group_by(BA) %>%
  mutate(perc_present = mean(value > 1)) %>%
  ungroup() %>%
  filter(perc_present > 0.25) %>%
  
  droplevels()
  
```


```{r}
ba_toTest %>%
  pivot_longer(cols=c("AGE", "BMI_RANGE"), names_to="variable_name", values_to="clinical_variable") %>%
  
  group_by(hierarchy, BA, variable_name) %>%
  do(tidy(lm(value_log ~ clinical_variable, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  
  group_by(hierarchy, variable_name) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup() %>%
  
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)

```



```{r}
ba_toTest %>%
  pivot_longer(cols=c("on_ppi", "SEX", "SMOKEEVER", "STATINS", "ASPIRIN", "HEARTBURN"), names_to="variable_name", values_to="clinical_variable") %>%
  mutate(clinical_variable = fct_relevel(clinical_variable, "No", after=0)) %>%
  
  group_by(hierarchy, BA, variable_name) %>%
  do(tidy(lm(value_log ~ clinical_variable, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  
  group_by(variable_name, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup() %>%
  
  filter(p.value < 0.05) %>%
  pander()

```

\newpage

# What is the signature of BE?


```{r}
## Subset the metadata file to only keep the samples you would like to test on
s_toTest <- s_ba 

## Set colors for each factor ahead of time so they are consistent through the report.
ann_colors = list(
  on_ppi = factor_palette(s_toTest$on_ppi, brewer.pal(3, "Set1")),
  ANTIBIO = factor_palette(s_toTest$ANTIBIO, brewer.pal(3, "Dark2")),
  study_group_collapse = factor_palette(s_toTest$study_group_collapse, as.character(wes_palette("Royal1")))
)

## Change this to be the breakdown of whatever variable the collaborator is interested in
addmargins(table(s_toTest$study_group_collapse, useNA = "ifany")) %>%
  pander(split.table=Inf)
```

## Linear models

```{r}
ba_toTest <- ba %>%
  left_join(s_toTest, by="subject_id") %>%
  
  group_by(BA) %>%
  mutate(perc_present = mean(value > 1)) %>%
  ungroup() %>%
  filter(perc_present > 0.25) %>%
  
  droplevels()
```



```{r fig.height=6, fig.width=14}
ba_toTest %>%
  
  ggplot(aes(x=study_group_collapse, y=value, color=on_ppi)) +
    geom_boxplot(outlier.alpha = 0) +
    geom_quasirandom(dodge.width = 0.75) +
    scale_color_manual(values=ann_colors$on_ppi) +
    scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, scales="free", ncol=4) +
    scale_y_continuous(trans="log10") +
    theme_clean() +
    theme(
      legend.position="bottom"
    ) +
    #guides(color=F) +s
    labs(
      x= "", color="", shape="",
      y="Bile acid levels")
```


### Fig 2B

```{r}
ba_annots <- read.table("/Users/tanesc/Documents/DBs/bile_acid/20230418_Bile_acid_structure.tsv", sep='\t', header = T) %>%
  select(BA=Abbreviation, Status,Conjugation)

ba_toTest %>%
  filter(hierarchy == "individual") %>%
  
  mutate(value_original = replace_na(value_original, 0)) %>%
  group_by(BA,study_group_collapse) %>%
  summarize(value = mean(value_original)) %>%
  ungroup() %>%
  
  mutate(BA = sub("_nM", "", BA)) %>%
  left_join(ba_annots, by="BA") %>% 
  mutate(Conjugation_status = ifelse(Conjugation %in% c("G", "T"), "conjugated", "unconjugated")) %>%
  mutate(group = paste(Status, Conjugation_status, sep = '\n')) %>%
  
  mutate(BA = factor(BA, levels=c("GCA", "GCDCA", "TCA", "TCDCA", "GDCA", "TDCA", "TLCA"))) %>%
  
  ggplot(aes(x=study_group_collapse, y=value, fill=BA)) +
    geom_bar(stat="identity") +
    facet_wrap(~group) +
    scale_fill_manual(values=c(brewer.pal(9, "Blues")[c(3,5,7,9)], brewer.pal(9, "Greens")[c(4,6,8)])) +
    theme_clean() +
    labs(
      x="",
      y="Bile acid levels (nM)"
    )
ggsave("betrnet_Fig2B.pdf", height=3, width=4.5, useDingbats=F)
```



value_log ~ on_ppi + study_group_collapse

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ on_ppi + study_group_collapse, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("study_group_collapse", "Healthy - ", term)) %>% 
  mutate(term = sub("on_ppi", "", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```




```{r fig.width=10}
summaries_df %>%
  #filter(term == "Healthy - Barrett's") %>%
  mutate(BA = reorder(BA, estimate)) %>%
  
  mutate(isSig = ifelse(fdr < 0.1, "q<0.1", "q>0.1")) %>%
  
  ggplot(aes(x=estimate, y=BA, shape=isSig)) +
    geom_vline(xintercept=0, linetype=2) +
    geom_point() +
    geom_linerange(aes(xmin = estimate - std.error, xmax = estimate + std.error)) +
    scale_shape_manual(values=c(16,1)) +
    facet_grid(hierarchy~term, scales="free_y", space="free_y") +
    theme_clean() +
    labs(
      x="Estimated mean difference\nbetween healthy and BE",
      y="", shape=""
    )

```


```{r}
summaries_df <- ba_toTest %>%
  
  mutate(PPI_study_group = fct_rev(interaction(on_ppi, study_group_collapse))) %>%
  droplevels() %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ PPI_study_group, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("PPI_study_group", "PPI.Barretts - ", term)) %>% 
  mutate(term = sub("on_ppi", "", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```


```{r fig.width=10}
summaries_df %>%
  #filter(term == "Healthy - Barrett's") %>%
  mutate(BA = reorder(BA, estimate)) %>%
  
  mutate(isSig = ifelse(fdr < 0.1, "q<0.1", "q>0.1")) %>%
  
  ggplot(aes(x=estimate, y=BA, shape=isSig)) +
    geom_vline(xintercept=0, linetype=2) +
    geom_point() +
    geom_linerange(aes(xmin = estimate - std.error, xmax = estimate + std.error)) +
    scale_shape_manual(values=c(16,1)) +
    facet_grid(hierarchy~term, scales="free_y", space="free_y") +
    theme_clean() +
    labs(
      x="Estimated mean difference\nbetween healthy and BE",
      y="", shape=""
    )

```


```{r}
summaries_df <- ba_toTest %>%
  filter(study_group_collapse == "Healthy") %>%
  #mutate(PPI_study_group = fct_rev(interaction(on_ppi, study_group_collapse))) %>%
  droplevels() %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ on_ppi, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("PPI_study_group", "PPI.Barretts - ", term)) %>% 
  mutate(term = sub("on_ppi", "", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```


## Generalized linear models 


```{r}
ba_toTest <- ba %>%
  left_join(s_toTest, by="subject_id") %>%
  mutate(BA_binary = as.numeric(!is.na(value_original))) %>%
  droplevels()

#ba_toTest %>%
#  group_by(BA, study_group_collapse) %>%
#  summarize(sum(is.na(value_original))) %>%
#  ungroup() %>% View()
```


### Fig 2A

```{r fig.height=6, fig.width=8}
ba_toTest %>%
  filter(study_group_collapse == "Healthy") %>%
  filter(hierarchy == "grouped") %>%
  group_by(BA) %>%
  summarize(ba_count = sum(BA_binary)/n()) %>%
  ungroup() %>%
  
  mutate(BA = sub("_nM", "", BA)) %>%
  mutate(BA = factor(BA, levels=c("Total", "Primary_Conjugated", "Secondary_Conjugated", "Primary_Unconjugated", "Secondary_Unconjugated"))) %>%
  mutate(BA = fct_relabel(BA, function(x) sub("_", "\n", x))) %>%
  
  ggplot(aes(x=BA, y=ba_count)) +
    geom_bar(stat="identity", position="dodge") +
    scale_y_continuous(labels=scales:::percent, limits = c(0,1)) +
    theme_clean() +
    theme(
      legend.position="bottom"
    ) +
    labs(
      x= "", fill="", shape="",
      y="Percent of samples with\nbile acid present")
ggsave("betrnet_Fig2A_percPresent.pdf", height=3, width=5, useDingbats=F)
```


```{r fig.height=6, fig.width=8}
ba_toTest %>%
  filter(study_group_collapse == "Healthy") %>%
  filter(hierarchy == "grouped") %>%
  filter(BA != "Total_nM") %>%
    
  mutate(BA = sub("_nM", "", BA)) %>%
  #mutate(BA = factor(BA, levels=c("Total", "Primary_Conjugated", "Secondary_Conjugated", "Primary_Unconjugated", "Secondary_Unconjugated"))) %>%
  mutate(BA = factor(BA, levels=c("Primary_Conjugated", "Secondary_Conjugated", "Primary_Unconjugated", "Secondary_Unconjugated"))) %>%
  mutate(BA = fct_relabel(BA, function(x) sub("_", "\n", x))) %>%
  
  ggplot(aes(x=BA, y=value)) +
    geom_boxplot(outlier.alpha=0) +
    geom_quasirandom() +
    #geom_bar(stat="identity") +
    scale_y_continuous(trans="log10") +
    #scale_y_continuous(labels=scales:::percent, limits = c(0,1)) +
    theme_clean() +
    theme(
      legend.position="bottom"
    ) +
    labs(
      x= "", fill="", shape="",
      y="Levels of bile acids in\nhealthy cohort")
ggsave("betrnet_Fig2A_levels.pdf", height=2.8, width=4.3, useDingbats=F)
```




```{r fig.height=6, fig.width=8}
ba_toTest %>%
  group_by(BA, study_group_collapse, on_ppi) %>%
  summarize(ba_count = sum(BA_binary)/n()) %>%
  ungroup() %>%
  
  ggplot(aes(x=study_group_collapse, y=ba_count, fill=on_ppi)) +
    geom_bar(stat="identity", position="dodge") +
    scale_fill_manual(values=ann_colors$on_ppi) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, ncol=4) +
    scale_y_continuous(labels=scales:::percent, limits = c(0,1)) +
    theme_clean() +
    theme(
      legend.position="bottom"
    ) +
    #guides(color=F) +s
    labs(
      x= "", fill="", shape="",
      y="Percent of samples with bile acid present")
```


Generalized linear models we used for the following tests. The bile acids levels were coded as present (1) and absent (0) and used as the outcome variable. Binomial regression is used to model the data.

BA_binary ~ on_ppi + study_group_collapse

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  do(tidy(glm(BA_binary ~ on_ppi + study_group_collapse, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("study_group_collapse", "Healthy - ", term)) %>% 
  mutate(term = sub("on_ppi", "", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)

```




```{r}
summaries_df <- ba_toTest %>%
  filter(study_group_collapse %in% "Healthy") %>%
  
  group_by(hierarchy, BA) %>%
  do(tidy(glm(BA_binary ~ on_ppi, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("study_group_collapse", "Healthy - ", term)) %>% 
  mutate(term = sub("on_ppi", "", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)

```

## Correlation with distances

```{r fig.height=8, fig.width=6}
pairwise_dists <- as.matrix(wu) %>%
  as_tibble(rownames="SampleID.x") %>%
  pivot_longer(names_to="SampleID.y", values_to="distance", -SampleID.x) %>%
  filter(SampleID.x != SampleID.y) %>%
  left_join(select(s, SampleID.x=SampleID, subject_id, study_group_collapse, sample_type_collapse, on_ppi, ANTIBIO), by="SampleID.x") %>%
  left_join(select(s, SampleID.y=SampleID, subject_id, study_group_collapse, sample_type_collapse), by="SampleID.y") %>%
  filter(subject_id.x == subject_id.y) %>%
  filter(subject_id.x %in% s_toTest$subject_id) %>%
  select(-subject_id.y) %>%
  rename(subject_id = subject_id.x) %>%
  #filter(sample_type_collapse.x %in% c("Saliva", "Oral wash")) %>%
  filter(sample_type_collapse.x %in% c("Oral wash")) %>%
  filter(sample_type_collapse.x != sample_type_collapse.y) %>%
  filter(sample_type_collapse.y %in% c("Saliva", "Squamous brushing", "Barrett's/Cardia brushing")) %>%
  
  inner_join(filter(ba, BA %in% c("Primary_Conjugated_nM", "Secondary_Conjugated_nM")), by="subject_id")



pairwise_dists %>%
  ggplot(aes(x=distance, y=value, color=study_group_collapse.x)) +
    geom_point() +
    geom_smooth(method="lm") +
    scale_y_continuous(trans="log10") +
    scale_color_manual(values=ann_colors$study_group_collapse) +
    facet_grid(sample_type_collapse.y ~ BA) + 
    theme_clean() +
    theme(
      legend.position="bottom"
    ) +
    labs(
      x="Distance to oral wash samples",
      y="Bile acid levels"
    )
ggsave("betrnet_BA_distance_correlation.pdf", height=7, width=5, useDingbats=F)
```

```{r}
pairwise_dists %>%
  group_by(BA, study_group_collapse.x, sample_type_collapse.y) %>%
  do(tidy(cor.test(~ distance + value_log, data=., method = "spearman"))) %>%
  ungroup() %>%
  #group_by(hierarchy, sample_type_collapse) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  #ungroup()
  select(BA, study_group_collapse.x, sample_type_collapse.y, estimate, statistic, p.value, fdr) %>%
  pander(split.table=Inf, digits=2)
  
```

# BE samples only

The samples that don't have any pathology information. The subjects are `r clinical_data %>% filter(is.na(FINAL_HX)) %>% pull(subject_id) %>% str_c(collapse=", ")`

```{r}
## Subset the metadata file to only keep the samples you would like to test on
s_toTest <- s_ba %>%
  filter(study_group_collapse %in% "Barrett's") %>%
  filter(!is.na(FINAL_HX)) %>%
  
  droplevels() %>%
  
  mutate(FINAL_HX_shorthand = fct_recode(FINAL_HX, NDBE="Intestinal metaplasia, no dysplasia", IND="Indefinite for dysplasia", LGD="Low grade dysplasia", HGD="High grade dysplasia", EAC="Adenocarcinoma")) %>%
  
  mutate(FINAL_HX_consec = FINAL_HX) %>%
  mutate(pathology2_consec = pathology2)

contrasts(s_toTest$FINAL_HX_consec) <- matrix(c(-4/5, 1/5, 1/5, 1/5, 1/5, -3/5, -3/5, 2/5, 2/5, 2/5, -2/5, -2/5, -2/5, 3/5, 3/5, -1/5, -1/5, -1/5, -1/5, 4/5), ncol = 4)
contrasts(s_toTest$pathology2_consec) <- matrix(c(-2/3, 1/3, 1/3, -1/3, -1/3, 2/3), ncol = 2) 

## Set colors for each factor ahead of time so they are consistent through the report.
ann_colors = list(
  on_ppi = factor_palette(s_toTest$on_ppi, brewer.pal(3, "Set1")),
  ANTIBIO = factor_palette(s_toTest$ANTIBIO, brewer.pal(3, "Dark2")),
  study_group_collapse = factor_palette(s_toTest$study_group_collapse, as.character(wes_palette("Royal1"))),
  FINAL_HX = factor_palette(s_toTest$FINAL_HX, viridis(length(levels(s_toTest$FINAL_HX)), end=0.8) ),
  pathology2 = factor_palette(s_toTest$pathology2, viridis(length(levels(s_toTest$pathology2)), end=0.8) )
)

## Change this to be the breakdown of whatever variable the collaborator is interested in
addmargins(table(s_toTest$FINAL_HX, useNA = "ifany")) %>%
  pander(split.table=Inf)
```

## Linear models

```{r}
ba_toTest <- ba %>%
  right_join(s_toTest, by="subject_id") %>%
  
  group_by(BA) %>%
  mutate(perc_present = mean(value > 1)) %>%
  ungroup() %>%
  filter(perc_present > 0.25) %>%
  
  droplevels()
```


### Fig 2C

```{r fig.width=20}
subject_order <- ba_toTest %>%
  filter(BA == "Total_nM") %>%
  arrange(value_log) %>%
  pull(subject_id)


ba_toTest %>%
  mutate(BA = sub("_nM", "", BA)) %>%
  mutate(BA = factor(BA, levels=c("GCA", "GCDCA", "TCA", "TCDCA", "GDCA", "TDCA", "TLCA", "Primary_Conjugated", "Secondary_Conjugated", "Total"))) %>%
  mutate(subject_id = factor(subject_id, levels=subject_order)) %>%
  #mutate(FINAL_HX = fct_relabel(FINAL_HX, function(x) gsub(" ", "\n", x))) %>%
  ggplot(aes(x=subject_id, y=BA, fill=value)) +
    geom_tile() +
    #scale_fill_continuous(trans="log10") +
    scale_fill_viridis(trans="log10", option="mako") +
    facet_grid(hierarchy ~ FINAL_HX_shorthand, scales="free", space="free") +
    theme_clean() +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.position = "bottom"
    ) +
    labs(
      x="Subjects", fill="BA levels (nM)",
      y=""
    )
ggsave("betrnet_Fig2C.pdf", height=2.5, width=9.8, useDingbats=F)
```


```{r fig.height=8, fig.width=14}
ba_toTest %>%
  
  ggplot(aes(x=FINAL_HX, color=FINAL_HX, y=value)) +
    geom_boxplot(outlier.alpha = 0) +
    geom_quasirandom(dodge.width = 0.75) +
    scale_color_manual(values=ann_colors$FINAL_HX) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, scales="free", ncol=4) +
    scale_y_continuous(trans="log10") +
    theme_clean() +
    theme(
      legend.position="bottom",
      axis.text.x = element_blank()
    ) +
    #guides(color=F) +
    labs(
      x= "", color="", shape="",
      y="Relative abundance")
```

For each sample type: props_log ~ FINAL_HX

Each pathology result is compared to the reference group of no dysplasia.

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ FINAL_HX, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("FINAL_HX", "No dysplasia - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  pander()
```




```{r fig.width=10}
summaries_df %>%
  filter(!grepl("Abx", term)) %>%
  mutate(term = sub("No dysplasia - ", "", term)) %>%
  mutate(term = factor(term, levels(s_toTest$FINAL_HX))) %>%
  mutate(BA = reorder(BA, estimate)) %>%
  
  mutate(isSig = ifelse(fdr < 0.1, "q<0.1", "q>0.1")) %>%
  
  ggplot(aes(x=estimate, y=BA, shape=isSig, color=term)) +
    geom_vline(xintercept=0, linetype=2) +
    #geom_point() +
    geom_pointrange(aes(xmin = estimate - std.error, xmax = estimate + std.error), position = position_dodge(width = 0.25)) +
    scale_color_manual(values=ann_colors$FINAL_HX) +
    scale_shape_manual(values=c(1,16)) +
    facet_grid(hierarchy~., scales="free_y", space="free_y") +
    theme_clean() +
    labs(
      x="Estimated mean difference\nwith no dysplasia group",
      y="", shape=""
    )

```




For each sample type: props_log ~ pathology_linear

The pathology levels are treated as ordered factors and a polynomial is fit across the levels.


```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ pathology_linear, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  mutate(term = sub("\\^", "", term)) %>%
  filter(p.value < 0.05) %>%
  pander()
```





```{r fig.height=8, fig.width=10, eval=T}
#Here is plot for the taxa that show a linear increase across pathology severity.
ba_toTest %>%
  ggplot(aes(x=FINAL_HX, color=FINAL_HX, y=value)) +
    geom_boxplot(outlier.alpha = 0) +
    geom_quasirandom(dodge.width = 0.75) +
    geom_smooth(method="lm", aes(group=1), color="black") +
    scale_color_manual(values=ann_colors$FINAL_HX) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, scales="free") +
    scale_y_continuous(trans="log10") +
    theme_clean() +
    theme(
      legend.position="bottom",
      axis.text.x = element_blank(),
      strip.text.y = element_text(angle = 0)
    ) +
    labs(
      x= "", color="", shape="",
      y="Relative abundance")
```



For each sample type: props_log ~ FINAL_HX_consec

The differences in relative abundances between consecutive time points are estimated.


```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ FINAL_HX_consec, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  pander()
```


The pathology results are grouped into no dysplasia, intermediate (Indefinite for dysplasia and Low grade dysplasia) and advanced (High grade dysplasia and Adenocarcinoma).


```{r fig.height=8, fig.width=14}
ba_toTest %>%
  
  ggplot(aes(x=pathology2, color=pathology2, y=value)) +
    geom_boxplot(outlier.alpha = 0) +
    geom_quasirandom(dodge.width = 0.75) +
    scale_color_manual(values=ann_colors$pathology2) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, scales="free", ncol=4) +
    scale_y_continuous(trans="log10") +
    theme_clean() +
    theme(
      legend.position="bottom"
    ) +
    #guides(color=F) +
    labs(
      x= "", color="", shape="",
      y="Relative abundance")
```



For each sample type: props_log ~ pathology2

Each pathology result is compared to the reference group of no dysplasia.

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy_lm_posthoc(lm(value_log ~ pathology2, data=.), "pathology2")) %>%
  ungroup() %>%
  
  filter(!grepl("Residuals", term)) %>%
  mutate(term = sub("ANTIBIO", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  pander()
```




```{r fig.width=10, fig.height=5}
summaries_df %>%
  filter(!grepl("Abx|pathology", term)) %>%
  mutate(isSig = ifelse(fdr < 0.1, "q<0.1", "q>0.1")) %>%
  ggplot(aes(x=estimate, y=BA, shape=isSig, color=term)) +
    geom_vline(xintercept=0, linetype=2) +
    geom_pointrange(aes(xmin = estimate - std.error, xmax = estimate + std.error), position = position_dodge(width = 0.25)) +
    scale_shape_manual(values=c(1,16)) +
    facet_grid(hierarchy~., space="free", scales="free") +
    theme_clean() +
    labs(
      x="Estimated mean difference\nbetween groups",
      y="", shape=""
    )
```

For each sample type: props_log ~ pathology2_linear

Linear models were used to estimate the change in relative abundance of select taxa between pathology groups. The relative abundances were log10 transformed. Multiple tests were adjusted for false discovery rate using Benjamini-Hochberg method. Only the terms with p<0.05 are shown in the table below.

The pathology levels are treated as ordered factors and a polynomial is fit across the levels.


```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ pathology2_linear, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  #mutate(term = sub("pathology2", "No dysplasia - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  mutate(term = sub("\\^", "", term)) %>%
  filter(p.value < 0.05) %>%
  pander()
```




## Generalized linear models




```{r}
ba_toTest <- ba %>%
  inner_join(s_toTest, by="subject_id") %>%
  mutate(BA_binary = as.numeric(!is.na(value_original))) %>%
  droplevels()

#ba_toTest %>%
#  group_by(BA, study_group_collapse) %>%
#  summarize(sum(is.na(value_original))) %>%
#  ungroup() %>% View()
```


```{r fig.height=6, fig.width=8}
ba_toTest %>%
  group_by(BA, FINAL_HX) %>%
  summarize(ba_count = sum(BA_binary)/n()) %>%
  ungroup() %>%
  
  ggplot(aes(x=FINAL_HX, y=ba_count, fill=FINAL_HX)) +
    geom_bar(stat="identity", position="dodge") +
    scale_fill_manual(values=ann_colors$FINAL_HX) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, ncol=4) +
    scale_y_continuous(labels=scales:::percent, limits = c(0,1)) +
    theme_clean() +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.position="bottom"
    ) +
    #guides(color=F) +s
    labs(
      x= "", fill="", shape="",
      y="Percent of samples with bile acid present")
```


Generalized linear models we used for the following tests. The bile acids levels were coded as present (1) and absent (0) and used as the outcome variable. Binomial regression is used to model the data.


BA_binary ~ FINAL_HX

Each pathology result is compared to the reference group of no dysplasia. Antibiotics use is added as a covariate.

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(glm(BA_binary ~ FINAL_HX, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("FINAL_HX", "No dysplasia - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```

BA_binary ~ pathology_linear

The pathology levels are treated as ordered factors and a polynomial is fit across the levels.


```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  do(tidy(glm(BA_binary ~ pathology_linear, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("FINAL_HX", "No dysplasia - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  mutate(term = sub("\\^", "", term)) %>%
  filter(p.value < 0.05) %>%
  pander()
```



For each sample type: BA_binary ~ FINAL_HX_consec

The differences in relative abundances between consecutive time points are estimated.


```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  do(tidy(glm(BA_binary ~ FINAL_HX_consec, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```


```{r fig.height=6, fig.width=8}
ba_toTest %>%
  group_by(BA, pathology2) %>%
  summarize(ba_count = sum(BA_binary)/n()) %>%
  ungroup() %>%
  
  ggplot(aes(x=pathology2, y=ba_count, fill=pathology2)) +
    geom_bar(stat="identity", position="dodge") +
    scale_fill_manual(values=ann_colors$pathology2) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, ncol=4) +
    scale_y_continuous(labels=scales:::percent, limits = c(0,1)) +
    theme_clean() +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.position="bottom"
    ) +
    #guides(color=F) +s
    labs(
      x= "", fill="", shape="",
      y="Percent of samples with bile acid present")
```


For each sample type: BA_binary ~ pathology2

Each pathology result is compared to the reference group of no dysplasia.

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  do(tidy(glm(BA_binary ~ pathology2, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  mutate(term = sub("pathology2", "No dysplasia - ", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup() 

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```



For each sample type: BA_binary ~ pathology2_linear

Linear models were used to estimate the change in relative abundance of select taxa between pathology groups. The relative abundances were log10 transformed. Multiple tests were adjusted for false discovery rate using Benjamini-Hochberg method. Only the terms with p<0.05 are shown in the table below.

The pathology levels are treated as ordered factors and a polynomial is fit across the levels.


```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  do(tidy(glm(BA_binary ~ pathology2_linear, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  #mutate(term = sub("pathology2", "No dysplasia - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  mutate(term = sub("\\^", "", term)) %>%
  filter(p.value < 0.05) %>%
  pander(split.table=Inf, digits=2)
  #kable_style(fdr, 0.1)
```


# Comparing pathology levels to healthy

The samples that don't have any pathology information. The subjects are `r clinical_data %>% filter(is.na(FINAL_HX)) %>% pull(subject_id) %>% str_c(collapse=", ")`

Only the subjects on PPI are included in this analysis.

```{r}
## Subset the metadata file to only keep the samples you would like to test on
s_toTest <- s_ba %>%
  filter(on_ppi %in% c("PPI")) %>%
  filter(!(is.na(FINAL_HX) & study_group_collapse%in%c("Barrett's"))) %>%
  droplevels()

## Set colors for each factor ahead of time so they are consistent through the report.
ann_colors = list(
  on_ppi = factor_palette(s_toTest$on_ppi, brewer.pal(3, "Set1")),
  ANTIBIO = factor_palette(s_toTest$ANTIBIO, brewer.pal(3, "Dark2")),
  study_group_collapse = factor_palette(s_toTest$study_group_collapse, as.character(wes_palette("Royal1"))),
  FINAL_HX = factor_palette(s_toTest$FINAL_HX, viridis(length(levels(s_toTest$FINAL_HX)), end=0.8) ),
  pathology2 = factor_palette(s_toTest$pathology2, viridis(length(levels(s_toTest$pathology2)), end=0.8) )
)

## Change this to be the breakdown of whatever variable the collaborator is interested in
addmargins(table(s_toTest$FINAL_HX, useNA = "ifany")) %>%
  pander(split.table=Inf)
```


## Linear models

```{r}
ba_toTest <- ba %>%
  inner_join(s_toTest, by="subject_id") %>%
  
  group_by(BA) %>%
  mutate(perc_present = mean(value > 1)) %>%
  ungroup() %>%
  filter(perc_present > 0.25) %>%
  
  droplevels()
```


```{r fig.height=8, fig.width=14}
ba_toTest %>%
  
  ggplot(aes(x=FINAL_HX, color=FINAL_HX, y=value)) +
    geom_boxplot(outlier.alpha = 0) +
    geom_quasirandom(dodge.width = 0.75) +
    scale_color_manual(values=ann_colors$FINAL_HX) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, scales="free", ncol=4) +
    scale_y_continuous(trans="log10") +
    theme_clean() +
    theme(
      legend.position="bottom",
      axis.text.x = element_blank()
    ) +
    #guides(color=F) +
    labs(
      x= "", color="", shape="",
      y="Relative abundance")
```

For each sample type: props_log ~ FINAL_HX

Linear models were used to estimate the change in relative abundance of select taxa between pathology groups. The relative abundances were log10 transformed. Multiple tests were adjusted for false discovery rate using Benjamini-Hochberg method. Only the terms with p<0.05 are shown in the table below.

Each pathology result is compared to the reference group of control samples.

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(BA, hierarchy) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(lm(value_log ~ FINAL_HX, data=.))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("FINAL_HX", "Healthy - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(term, hierarchy) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1) %>%
  column_spec(c(1:3), width = "6em") %>%
  column_spec(c(4:8), width = "3em")
```




```{r fig.width=10, fig.height=8}

summaries_df %>%
  filter(!grepl("Abx", term)) %>%
  mutate(term = sub("Healthy - ", "", term)) %>%
  mutate(term = factor(term, levels(ba_toTest$FINAL_HX))) %>%
  mutate(BA = reorder(BA, estimate)) %>%
  
  mutate(isSig = ifelse(fdr < 0.1, "q<0.1", "q>0.1")) %>%
  
  ggplot(aes(x=estimate, y=BA, shape=isSig, color=term)) +
    geom_vline(xintercept=0, linetype=2) +
    #geom_point() +
    geom_pointrange(aes(xmin = estimate - std.error, xmax = estimate + std.error), position = position_dodge(width = 0.6)) +
    scale_color_manual(values=ann_colors$FINAL_HX) +
    scale_shape_manual(values=c(16,1)) +
    facet_grid(hierarchy~., scales="free", space="free") +
    theme_clean() +
    labs(
      x="Estimated mean difference\nwith control group",
      y="", shape=""
    )

```



## Generalized linear models


```{r}
ba_toTest <- ba %>%
  inner_join(s_toTest, by="subject_id") %>%
  mutate(BA_binary = as.numeric(!is.na(value_original))) %>%
  droplevels()

#ba_toTest %>%
#  group_by(BA, study_group_collapse) %>%
#  summarize(sum(is.na(value_original))) %>%
#  ungroup() %>% View()
```

```{r fig.height=6, fig.width=8}
ba_toTest %>%
  group_by(BA, FINAL_HX) %>%
  summarize(ba_count = sum(BA_binary)/n()) %>%
  ungroup() %>%
  
  ggplot(aes(x=FINAL_HX, y=ba_count, fill=FINAL_HX)) +
    geom_bar(stat="identity", position="dodge") +
    scale_fill_manual(values=ann_colors$FINAL_HX) +
    #scale_shape_manual(values=c(16,1)) +
    facet_wrap(~BA, ncol=4) +
    scale_y_continuous(labels=scales:::percent, limits = c(0,1)) +
    theme_clean() +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.position="bottom"
    ) +
    #guides(color=F) +s
    labs(
      x= "", fill="", shape="",
      y="Percent of samples with bile acid present")
```


Generalized linear models we used for the following tests. The bile acids levels were coded as present (1) and absent (0) and used as the outcome variable. Binomial regression is used to model the data.


BA_binary ~ FINAL_HX

Each pathology result is compared to the reference group of no dysplasia.

```{r}
summaries_df <- ba_toTest %>%
  
  group_by(hierarchy, BA) %>%
  #do(tidy_lmer(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit))) %>%
  #do(tidy_lmer2(nlme::lme(props_logit ~ study_group, random=~1|subject_id, data=., na.action=na.omit), "study_group")) %>%
  do(tidy(glm(BA_binary ~ FINAL_HX, data=., family="binomial"))) %>%
  ungroup() %>%
  
  filter(!grepl("Intercept", term)) %>%
  mutate(term = sub("FINAL_HX", "Control - ", term)) %>% 
  mutate(term = sub("ANTIBIOYes", "Abx use", term)) %>%
  
  group_by(hierarchy, term) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

summaries_df %>%
  filter(p.value < 0.05) %>%
  kable_style(fdr, 0.1)
```

# Correlation with bacteria


```{r}
met_and_bacteria <- summed_props %>%
  as.data.frame() %>% 
  rownames_to_column("Taxa") %>% 
  pivot_longer(-Taxa, names_to="SampleID", values_to="props") %>%
  
  left_join(select(s, SampleID, subject_id, sample_type_collapse, study_group_collapse), by="SampleID")  %>%
  filter(subject_id %in% s_ba$subject_id) %>%
  
  filter(sample_type_collapse %in% c("Barrett's/Cardia brushing", "Squamous brushing", "Saliva", "Oral wash")) %>%
  mutate(sample_type_collapse = fct_recode(sample_type_collapse, `Squamous`="Squamous brushing", `Cardia and Barretts`="Barrett's/Cardia brushing")) %>%
  
  filter(Taxa %in% c("p__Actinobacteria g__Actinomyces", "p__Bacteroidetes g__Prevotella", "p__Bacteroidetes g__[Prevotella]", "p__Firmicutes g__Streptococcus", "p__Firmicutes g__Lactobacillus", "p__Firmicutes g__Megasphaera", "p__Firmicutes g__Selenomonas", "p__Firmicutes g__Oribacterium",  "p__Fusobacteria g__Fusobacterium", "p__Proteobacteria g__Neisseria", "p__Proteobacteria g__Campylobacter")) %>%
  #group_by(Taxa, sample_type_collapse) %>%
  #mutate(mean_prop_bacteria = mean(props)) %>%
  #ungroup() %>%
  #group_by(Taxa) %>%
  #mutate(mean_prop_max_bacteria = max(mean_prop_bacteria)) %>%
  #ungroup() %>%
  
  #filter(mean_prop_max_bacteria > 0.01) %>%
  #filter(Taxa != "Bacteria") %>%
  #filter(Taxa != "p__Firmicutes g__Sarcina") %>% ## only one sample with high levels of this bacteria
  #filter(!grepl("Marine|Bradyrhizobium", Taxa)) %>%
  droplevels() %>%
  
  mutate(Taxa = gsub("[pcofgs]__", "", Taxa)) %>%
  
  mutate(props_original = props) %>%
  mutate(props = props + min(filter(., props>0)$props) / 10) %>%
  mutate(props_log = log10(props)) %>%

  inner_join(filter(ba, perc_present > 0.25), by="subject_id")

```


For each sample type: Spearman correlation between levels of bile acids and relative abundance of bacteria  


```{r}
summaries_df <- met_and_bacteria %>%
  #filter(mean_prop_bacteria > 0.01) %>%
  group_by(BA, hierarchy, Taxa, sample_type_collapse) %>%
  #do(tidy_lmer(nlme::lme(props_log ~ value_log, random=~1|SubjectID, data=., na.action=na.omit))) %>% ## do this if there are repeated measures
  do(tidy(cor.test(~ value + props, data=., method = "spearman"))) %>%
  ungroup() %>%
  #filter(!grepl("Intercept", term)) %>%
  group_by(hierarchy, sample_type_collapse) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

```


### Supp fig 3B

```{r fig.height=7, fig.width=11}
p_stars <- function (pvals) {
  cut(pvals, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", ""))
}

summaries_df %>%
  
  mutate(p_label = p_stars(fdr)) %>%
  mutate(label_color = ifelse(abs(estimate) > 0.3, "A", "B")) %>%
  separate(Taxa, into=c("Phylum", "Genus"), sep=" ") %>%
  mutate(Genus = sub("\\[Prevotella\\]", "Alloprevotella", Genus)) %>%
  mutate(BA = sub("_nM", "", BA)) %>%
  mutate(BA = factor(BA, levels=c("GCA", "GCDCA", "TCA", "TCDCA", "GDCA", "TDCA", "TLCA", "Primary_Conjugated", "Secondary_Conjugated", "Total"))) %>%
  
  ggplot(aes(x=BA, y=Genus, fill=estimate)) +
    geom_tile(fill = "white", color="black") +
    geom_point(shape = 21, aes(size = abs(estimate)), color="white") +
    geom_text(aes(label=p_label, color=label_color), size=3.5, vjust=0.76) +
    facet_grid(Phylum~sample_type_collapse, space="free", scales="free") +
    scale_x_discrete(expand=c(0,0)) +
    scale_y_discrete(expand=c(0,0)) +
    #scale_size_area(limits=c(-0.65, 0.65)) +
    #scale_fill_gradient2(low = brewer.pal(11, 'RdBu')[11], high = brewer.pal(11, 'RdBu')[1], mid=brewer.pal(11, 'RdBu')[6], midpoint=0, limits=c(-0.65, 0.65)) +
    scale_fill_gradient2(low = brewer.pal(11, 'RdBu')[11], high = brewer.pal(11, 'RdBu')[1], mid=brewer.pal(11, 'RdBu')[6], midpoint=0) +
    scale_color_manual(values=c("#D3D3D3", "#000000")) +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
      strip.text.y = element_text(angle = 0),
      strip.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA)
    ) +
    guides(size="none", color="none") +
    labs(
      x="", fill="Correlation\ncoefficient",
      y=""
    )
ggsave("betrnet_SuppFig3b.pdf", height=5, width=12, useDingbats=F)
```

```{r}
shannon_temp <- s %>% 
  select(SampleID, props=Shannon) %>%
  mutate(Phenotype_category = "Alpha diversity") %>%
  mutate(Phenotype = "Shannon")

met_and_bacteria <- props_with_phenotypes %>%
  filter(Phenotype_category == "gram_stain") %>%
  
  bind_rows(shannon_temp) %>%
  
  left_join(select(s, SampleID, subject_id, sample_type_collapse, study_group_collapse, on_ppi), by="SampleID")  %>%
  filter(subject_id %in% s_ba$subject_id) %>%
  
  filter(sample_type_collapse %in% c("Barrett's/Cardia brushing", "Squamous brushing", "Saliva", "Oral wash")) %>%
  mutate(sample_type_collapse = fct_recode(sample_type_collapse, `Squamous`="Squamous brushing", `Cardia and Barretts`="Barrett's/Cardia brushing")) %>%
  
  mutate(props_original = props) %>%
  mutate(props = props + min(filter(., props>0)$props) / 10) %>%
  mutate(props_log = log10(props)) %>%

  inner_join(filter(ba, perc_present > 0.25), by="subject_id")




```


For each sample type: Spearman correlation between levels of bile acids and relative abundance of bacterial phenotypes


```{r}
summaries_df <- met_and_bacteria %>%
  #filter(mean_prop_bacteria > 0.01) %>%
  group_by(BA, hierarchy, Phenotype, sample_type_collapse) %>%
  #do(tidy_lmer(nlme::lme(props_log ~ value_log, random=~1|SubjectID, data=., na.action=na.omit))) %>% ## do this if there are repeated measures
  do(tidy(cor.test(~ value + props, data=., method = "spearman"))) %>%
  ungroup() %>%
  #filter(!grepl("Intercept", term)) %>%
  group_by(hierarchy, sample_type_collapse) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

```

### Fig 2D

```{r fig.height=4, fig.width=10}
## This plot needs a lot of tweaking to make it look good. 
## If it's giving you too much trouble include the next block instead.
p_stars <- function (pvals) {
  cut(pvals, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", ""))
}

summaries_df %>%
  filter(Phenotype != "Not annotated") %>%
  #mutate(Phenotype_group = ifelse(Phenotype %in% "Shannon", "Diversity", "Bacteria")) %>%
  
  mutate(BA = sub("_nM", "", BA)) %>%
  mutate(BA = factor(BA, levels=c("GCA", "GCDCA", "TCA", "TCDCA", "GDCA", "TDCA", "TLCA", "Primary_Conjugated", "Secondary_Conjugated", "Total"))) %>%
  
  mutate(p_label = p_stars(fdr)) %>%
  mutate(label_color = ifelse(abs(estimate) > 0.5, "A", "B")) %>%
  
  ggplot(aes(x=BA, y=Phenotype, fill=estimate)) +
    geom_tile(fill = "white", color="black") +
    geom_point(shape = 21, aes(size = abs(estimate)), color="white") +
    geom_text(aes(label=p_label, color=label_color), size=3.5, vjust=0.76) +
    facet_grid(.~sample_type_collapse) +
    #facet_grid(.~sample_type_collapse, space="free", scales="free") +
    scale_x_discrete(expand=c(0,0)) +
    scale_y_discrete(expand=c(0,0)) +
    scale_fill_gradient2(low = brewer.pal(11, 'RdBu')[11], high = brewer.pal(11, 'RdBu')[1], mid=brewer.pal(11, 'RdBu')[6], midpoint=0) +
    scale_color_manual(values=c("#D3D3D3", "#000000")) +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
      strip.text.y = element_text(angle = 0),
      #strip.text.x = element_text(angle = 90),
      strip.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      legend.position = "bottom"
    ) +
    coord_equal() +
    guides(size="none", color="none") +
    labs(
      x="", fill="Correlation\ncoefficient",
      y=""
    )
ggsave("betrnet_Fig2D.pdf", height=4, width=9.1, useDingbats=F)
```




For each sample type: Spearman correlation between levels of bile acids and relative abundance of bacterial phenotypes


```{r}
summaries_df <- met_and_bacteria %>%
  #filter(mean_prop_bacteria > 0.01) %>%
  group_by(BA, hierarchy, Phenotype, sample_type_collapse, study_group_collapse) %>%
  #do(tidy_lmer(nlme::lme(props_log ~ value_log, random=~1|SubjectID, data=., na.action=na.omit))) %>% ## do this if there are repeated measures
  do(tidy(cor.test(~ value + props, data=., method = "spearman"))) %>%
  ungroup() %>%
  #filter(!grepl("Intercept", term)) %>%
  group_by(hierarchy, sample_type_collapse, study_group_collapse) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

```



```{r fig.height=4, fig.width=10}
## This plot needs a lot of tweaking to make it look good. 
## If it's giving you too much trouble include the next block instead.
p_stars <- function (pvals) {
  cut(pvals, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", ""))
}

summaries_df %>%
  filter(Phenotype != "Not annotated") %>%
  #mutate(Phenotype_group = ifelse(Phenotype %in% "Shannon", "Diversity", "Bacteria")) %>%
  
  mutate(BA = sub("_nM", "", BA)) %>%
  mutate(BA = factor(BA, levels=c("GCA", "GCDCA", "TCA", "TCDCA", "GDCA", "TDCA", "TLCA", "Primary_Conjugated", "Secondary_Conjugated", "Total"))) %>%
  
  mutate(p_label = p_stars(fdr)) %>%
  mutate(label_color = ifelse(abs(estimate) > 0.5, "A", "B")) %>%
  
  ggplot(aes(x=BA, y=Phenotype, fill=estimate)) +
    geom_tile(fill = "white", color="black") +
    geom_point(shape = 21, aes(size = abs(estimate)), color="white") +
    geom_text(aes(label=p_label, color=label_color), size=3.5, vjust=0.76) +
    facet_grid(study_group_collapse~sample_type_collapse) +
    #facet_grid(.~sample_type_collapse, space="free", scales="free") +
    scale_x_discrete(expand=c(0,0)) +
    scale_y_discrete(expand=c(0,0)) +
    scale_fill_gradient2(low = brewer.pal(11, 'RdBu')[11], high = brewer.pal(11, 'RdBu')[1], mid=brewer.pal(11, 'RdBu')[6], midpoint=0) +
    scale_color_manual(values=c("#D3D3D3", "#000000")) +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
      strip.text.y = element_text(angle = 0),
      #strip.text.x = element_text(angle = 90),
      strip.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      legend.position = "bottom"
    ) +
    coord_equal() +
    guides(size="none", color="none") +
    labs(
      x="", fill="Correlation\ncoefficient",
      y=""
    )
ggsave("betrnet_Fig2D_alt.pdf", height=4, width=9.1, useDingbats=F)
```




For each sample type: Spearman correlation between levels of bile acids and relative abundance of bacterial phenotypes


```{r}
summaries_df <- met_and_bacteria %>%
  #filter(mean_prop_bacteria > 0.01) %>%
  group_by(BA, hierarchy, Phenotype, sample_type_collapse, study_group_collapse, on_ppi) %>%
  #do(tidy_lmer(nlme::lme(props_log ~ value_log, random=~1|SubjectID, data=., na.action=na.omit))) %>% ## do this if there are repeated measures
  do(tidy(cor.test(~ value + props, data=., method = "spearman"))) %>%
  ungroup() %>%
  #filter(!grepl("Intercept", term)) %>%
  group_by(hierarchy, sample_type_collapse, study_group_collapse, on_ppi) %>%
  mutate(fdr = p.adjust(p.value, method="BH")) %>%
  ungroup()

```

### Supp fig 3A

```{r fig.height=4, fig.width=10}
## This plot needs a lot of tweaking to make it look good. 
## If it's giving you too much trouble include the next block instead.
p_stars <- function (pvals) {
  cut(pvals, breaks = c(-Inf, 0.001, 0.01, 0.05, Inf), labels = c("***", "**", "*", ""))
}

summaries_df %>%
  filter(Phenotype != "Not annotated") %>%
  #mutate(Phenotype_group = ifelse(Phenotype %in% "Shannon", "Diversity", "Bacteria")) %>%
  
  mutate(BA = sub("_nM", "", BA)) %>%
  mutate(BA = factor(BA, levels=c("GCA", "GCDCA", "TCA", "TCDCA", "GDCA", "TDCA", "TLCA", "Primary_Conjugated", "Secondary_Conjugated", "Total"))) %>%
  
  mutate(p_label = p_stars(fdr)) %>%
  mutate(label_color = ifelse(abs(estimate) > 0.5, "A", "B")) %>%
  
  mutate(on_ppi = ifelse(on_ppi, "PPI", "no-PPI")) %>%
  
  ggplot(aes(x=BA, y=Phenotype, fill=estimate)) +
    geom_tile(fill = "white", color="black") +
    geom_point(shape = 21, aes(size = abs(estimate)), color="white") +
    geom_text(aes(label=p_label, color=label_color), size=3.5, vjust=0.76) +
    facet_grid(study_group_collapse+on_ppi~sample_type_collapse) +
    #facet_grid(.~sample_type_collapse, space="free", scales="free") +
    scale_x_discrete(expand=c(0,0)) +
    scale_y_discrete(expand=c(0,0)) +
    scale_size_area(limits=c(-0.65, 0.65)) +
    scale_fill_gradient2(low = brewer.pal(11, 'RdBu')[11], high = brewer.pal(11, 'RdBu')[1], mid=brewer.pal(11, 'RdBu')[6], midpoint=0, limits=c(-0.65, 0.65)) +
    scale_color_manual(values=c("#D3D3D3", "#000000")) +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
      strip.text.y = element_text(angle = 0),
      #strip.text.x = element_text(angle = 90),
      strip.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      #legend.position = "bottom"
    ) +
    coord_equal() +
    guides(size="none", color="none") +
    labs(
      x="", fill="Correlation\ncoefficient",
      y=""
    )
ggsave("betrnet_SuppFig3a.pdf", height=7, width=12, useDingbats=F)
```
